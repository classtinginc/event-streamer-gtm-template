___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "event-streamer-send-event",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "EVENT_STREAMER_ENDPOINT",
    "displayName": "EVENT_STREAMER_ENDPOINT",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "DISTINCT_ID",
    "displayName": "DISTINCT_ID",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "EVENT_NAME",
    "displayName": "EVENT_NAME",
    "simpleValueType": true
  },
  {
    "type": "PARAM_TABLE",
    "name": "EVENT_PROPS",
    "displayName": "EVENT_PROPS",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "Key",
          "displayName": "Key",
          "simpleValueType": true
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "Value",
          "displayName": "Value",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "JSON_EVENT_PROPS",
    "displayName": "JSON_EVENT_PROPS",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "Value",
        "type": "TEXT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const JSON  = require('JSON');

const EVENT_STREAMER_SDK_SCRIPT_URL = 'https://assets.classting.com/google-tag-manager/event-streamer-sdk.js';

injectScript(
  EVENT_STREAMER_SDK_SCRIPT_URL, 
  handleSendEvent,
  data.gtmOnFailure
);

function handleSendEvent() {
  const SEND_EVENT_METHOD_KEY = 'sendEvent';

  const EVENT_PROPS = getOrDefault(data.EVENT_PROPS, [])
    .reduce((acc, x) => {
      acc[x.Key] = getOrDefault(x.Value, null);
      return acc;
    }, {});
  const FLATTEN_JSON_EVENT_PROPS = getOrDefault(data.JSON_EVENT_PROPS, [])
    .reduce(function(acc, x) {
      var parsed = JSON.parse(x.Value);
      for (var key in parsed) {
        acc[key] = parsed[key];
      }
      return acc;
  }, {});
  
  callInWindow(
    SEND_EVENT_METHOD_KEY, 
    data.EVENT_STREAMER_ENDPOINT, 
    getOrDefault(data.DISTINCT_ID, null), 
    getOrDefault(data.EVENT_NAME, null), 
    mergeDict(EVENT_PROPS, FLATTEN_JSON_EVENT_PROPS)
  );
  
  data.gtmOnSuccess();
}

function getOrDefault(inputValue, defaultValue) {
  if (inputValue === undefined) {
    return defaultValue;
  }
  return inputValue;
}
       
function mergeDict(dict1, dict2) {
  let merged = dict1;
  for(let key in dict2) {
    merged[key] = dict2[key];
  }
  return merged;
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sendEvent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://assets.classting.com/google-tag-manager/event-streamer-sdk.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: test_send_event_with_expected_params
  code: "// Arrange\nconst mockData = {\n  EVENT_STREAMER_ENDPOINT: 'http://example.com',\n\
    \  DISTINCT_ID: 'user_123',\n  EVENT_NAME: 'test_event',\n  EVENT_PROPS: [ \n\
    \    {\"Key\": \"Apple\", \"Value\": 1}  \n  ],\n  JSON_EVENT_PROPS: [\n    {'Value':\
    \ '{\"Banana\": 2}'}\n  ]\n};\n\nmock('injectScript', (url, onSuccess, onFail)\
    \ => onSuccess());\nmock('callInWindow', null);\n\n// Act\nrunCode(mockData);\n\
    \n// Assert\nassertApi('callInWindow').wasCalledWith(\n  'sendEvent',\n  'http://example.com',\n\
    \  'user_123',\n  'test_event',\n  {\"Apple\": 1, \"Banana\": 2}\n);\nassertApi('gtmOnSuccess').wasCalled();"
- name: test_call_gtmOnFailure_when_script_injection_failed
  code: |-
    // Arrange
    mock('injectScript', (url, onSuccess, onFail) => onFail());

    // Act
    runCode({});

    // Assert
    assertApi('gtmOnFailure').wasCalled();


___NOTES___

Created on 2024. 10. 25. 오후 6:01:02


